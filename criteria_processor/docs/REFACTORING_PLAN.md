# 🔧 План рефакторинга проекта анализа критериев

## 📊 Анализ текущего состояния

### Проблемы текущей архитектуры:
- ❌ Все скрипты разбросаны по корню проекта (17 Python файлов)
- ❌ Файлы превышают 200+ строк (data_utils.py - 293, criteria_checkers.py - 230, serper_utils.py - 229)
- ❌ Нет четкой структуры папок по функциональности
- ❌ Смешана бизнес-логика с утилитами
- ❌ Документация разбросана по разным md файлам
- ❌ Тесты в корне проекта

### Текущие файлы и их размеры:
```
config.py (110 строк) ✅
data_utils.py (293 строки) ❌ - разбить
main.py (157 строк) ✅
criteria_checkers.py (230 строк) ❌ - разбить  
serper_utils.py (229 строк) ❌ - разбить
json_formatter.py (222 строки) ❌ - разбить
test_structure.py (163 строк) ✅
scoring_system.py (157 строк) ✅
sanctions_checker.py (98 строк) ✅ 
logger_config.py (60 строк) ✅
models.py (37 строк) ✅
```

## 🏗️ Целевая архитектура

```
src/
├── core/               # Основная бизнес-логика
│   ├── __init__.py
│   ├── analyzer.py     # Главный анализатор (из main.py)
│   ├── processor.py    # Обработка компаний
│   └── workflow.py     # Алгоритм работы
├── criteria/           # Проверка критериев
│   ├── __init__.py
│   ├── general.py      # General критерии  
│   ├── qualification.py # Квалификационные
│   ├── mandatory.py    # Обязательные
│   ├── nth.py          # Nice-to-Have
│   └── base.py         # Базовый класс
├── data/               # Работа с данными
│   ├── __init__.py
│   ├── loaders.py      # Загрузка файлов
│   ├── encodings.py    # Работа с кодировками
│   ├── savers.py       # Сохранение результатов
│   └── validators.py   # Валидация данных
├── external/           # Внешние API
│   ├── __init__.py
│   ├── serper.py       # Serper.dev API
│   ├── openai_client.py # OpenAI API
│   └── rate_limiter.py # Ограничения запросов
├── formatters/         # Форматирование выводов
│   ├── __init__.py
│   ├── json_format.py  # JSON форматирование
│   ├── csv_format.py   # CSV форматирование  
│   └── structured.py   # Структурированный вывод
├── utils/              # Утилиты
│   ├── __init__.py
│   ├── logging.py      # Логирование
│   ├── config.py       # Конфигурация
│   ├── models.py       # Модели данных
│   └── helpers.py      # Вспомогательные функции
└── filters/            # Фильтры и проверки
    ├── __init__.py
    ├── sanctions.py    # Санкционные проверки
    └── scoring.py      # Система скоринга

tests/                  # Тесты
├── __init__.py
├── test_core/
├── test_criteria/
├── test_data/
├── test_external/
├── test_formatters/
├── test_utils/
└── test_integration.py

config/                 # Конфигурационные файлы
├── settings.py
├── prompts.yaml
└── schemas.json

docs/                   # Документация
├── api/
├── architecture/
├── setup/
└── user_guide/

data/                   # Данные (переименовать из input/)
├── criteria/
├── companies/
└── samples/

output/                 # Результаты (как есть)

scripts/                # Вспомогательные скрипты
├── setup_env.py
├── validate_data.py
└── migrate_old_format.py
```

## 🎯 Поэтапный план рефакторинга

### 📋 ЭТАП 1: Подготовка инфраструктуры (1-2 часа)

#### ✅ Задача 1.1: Создание новой структуры папок
- [ ] Создать папку `src/` с подпапками
- [ ] Создать папку `tests/` с подпапками  
- [ ] Создать папку `config/`
- [ ] Переименовать `input/` → `data/`
- [ ] Создать все `__init__.py` файлы

#### ✅ Задача 1.2: Миграция конфигурации
- [ ] Переместить `config.py` → `src/utils/config.py`
- [ ] Переместить `promt_generate.yaml` → `config/prompts.yaml`
- [ ] Обновить пути в конфигурации
- [ ] Создать `config/settings.py` для центральных настроек

#### ✅ Задача 1.3: Тестирование этапа 1
- [ ] Запустить `python -m pytest tests/` (должны быть пустые тесты)
- [ ] Проверить импорты новой структуры

### 📋 ЭТАП 2: Миграция утилит (2-3 часа)

#### ✅ Задача 2.1: Перенос логирования
- [ ] `logger_config.py` → `src/utils/logging.py`
- [ ] Обновить импорты во всех файлах
- [ ] Добавить конфигурацию логирования в settings

#### ✅ Задача 2.2: Перенос моделей
- [ ] `models.py` → `src/utils/models.py`
- [ ] Добавить дополнительные модели данных
- [ ] Обновить импорты

#### ✅ Задача 2.3: Рефакторинг data_utils.py (293 строки → <100 каждый)
- [ ] `detect_encoding()`, `load_csv_with_encoding()` → `src/data/encodings.py`
- [ ] `load_companies_data()`, `load_all_criteria_files()`, `load_data()` → `src/data/loaders.py`
- [ ] `save_results()`, `flatten_result_for_csv()` → `src/data/savers.py`

#### ✅ Задача 2.4: Тестирование этапа 2
- [ ] Создать `tests/test_data/test_loaders.py`
- [ ] Создать `tests/test_utils/test_logging.py`
- [ ] Запустить тесты: `python -m pytest tests/test_data/ tests/test_utils/`

### 📋 ЭТАП 3: Внешние API (2-3 часа)

#### ✅ Задача 3.1: Рефакторинг serper_utils.py (229 строк → <100 каждый)
- [ ] Основной API клиент → `src/external/serper.py`
- [ ] Rate limiting → `src/external/rate_limiter.py`
- [ ] Переместить OpenAI функции → `src/external/openai_client.py`

#### ✅ Задача 3.2: Обновление моделей взаимодействия
- [ ] Создать `src/external/__init__.py` с фасадом
- [ ] Унифицировать обработку ошибок API
- [ ] Добавить ретраи и тайм-ауты

#### ✅ Задача 3.3: Тестирование этапа 3
- [ ] Создать `tests/test_external/test_serper.py`
- [ ] Создать `tests/test_external/test_openai_client.py`
- [ ] Тест интеграции: `python -m pytest tests/test_external/`

### 📋 ЭТАП 4: Критерии и фильтры (3-4 часа)

#### ✅ Задача 4.1: Рефакторинг criteria_checkers.py (230 строк → <100 каждый)  
- [ ] `check_general_criteria()` → `src/criteria/general.py`
- [ ] `check_qualification_questions()` → `src/criteria/qualification.py`
- [ ] `check_mandatory_criteria()` → `src/criteria/mandatory.py`
- [ ] `check_nth_criteria()` → `src/criteria/nth.py`
- [ ] Общие функции → `src/criteria/base.py`

#### ✅ Задача 4.2: Перенос фильтров
- [ ] `sanctions_checker.py` → `src/filters/sanctions.py`
- [ ] `scoring_system.py` → `src/filters/scoring.py`

#### ✅ Задача 4.3: Создание базового класса критериев
- [ ] Создать `CriteriaChecker` базовый класс в `src/criteria/base.py`
- [ ] Наследовать все типы критериев от базового класса
- [ ] Унифицировать интерфейс проверки

#### ✅ Задача 4.4: Тестирование этапа 4
- [ ] Создать тесты для каждого типа критериев
- [ ] Тест sanctions и scoring: `python -m pytest tests/test_filters/`
- [ ] Интеграционный тест критериев

### 📋 ЭТАП 5: Форматирование и основная логика (2-3 часа)

#### ✅ Задача 5.1: Рефакторинг json_formatter.py (222 строки → <100 каждый)
- [ ] JSON форматирование → `src/formatters/json_format.py`
- [ ] CSV форматирование → `src/formatters/csv_format.py`
- [ ] Структурированный вывод → `src/formatters/structured.py`

#### ✅ Задача 5.2: Рефакторинг main.py
- [ ] Основной анализатор → `src/core/analyzer.py`
- [ ] Обработка компаний → `src/core/processor.py`
- [ ] Бизнес-алгоритм → `src/core/workflow.py`
- [ ] Оставить минимальный `main.py` как точку входа

#### ✅ Задача 5.3: Тестирование этапа 5
- [ ] Создать `tests/test_formatters/`
- [ ] Создать `tests/test_core/`
- [ ] Интеграционный тест: `python -m pytest tests/test_integration.py`

### 📋 ЭТАП 6: Тесты и документация (2-3 часа)

#### ✅ Задача 6.1: Перенос и обновление тестов
- [ ] `test_structure.py` → `tests/test_integration.py`
- [ ] Создать модульные тесты для всех компонентов
- [ ] Добавить покрытие тестами (pytest-cov)

#### ✅ Задача 6.2: Обновление документации
- [ ] Переместить все md файлы в `docs/`
- [ ] Обновить `README.md` с новой структурой
- [ ] Создать `docs/architecture/structure.md`
- [ ] Создать `docs/api/` документацию

#### ✅ Задача 6.3: Создание скриптов
- [ ] `scripts/setup_env.py` для настройки окружения
- [ ] `scripts/validate_data.py` для проверки данных
- [ ] `scripts/migrate_old_format.py` для миграции старых данных

### 📋 ЭТАП 7: Финальная проверка и оптимизация (1-2 часа)

#### ✅ Задача 7.1: Комплексное тестирование
- [ ] Запустить полный набор тестов: `python -m pytest tests/ -v`
- [ ] Проверить покрытие: `python -m pytest tests/ --cov=src/`
- [ ] Тест производительности: сравнить с оригиналом

#### ✅ Задача 7.2: Очистка корня проекта
- [ ] Удалить старые файлы после успешной миграции
- [ ] Обновить `.gitignore`
- [ ] Обновить `requirements.txt`

#### ✅ Задача 7.3: Финальная документация
- [ ] Обновить `README.md` с новыми инструкциями
- [ ] Создать `MIGRATION.md` с описанием изменений
- [ ] Добавить примеры использования в `docs/user_guide/`

## 🚀 Преимущества новой архитектуры

### ✅ Улучшения:
- 📁 **Четкая структура**: каждый модуль в своей папке
- 📏 **Малые файлы**: все файлы <200 строк  
- 🧪 **Тестируемость**: модульные тесты для каждого компонента
- 🔧 **Поддерживаемость**: легко найти и изменить код
- 📖 **Документация**: структурированная документация
- 🔄 **Расширяемость**: легко добавлять новые критерии/форматы

### 📊 Метрики качества:
- **Цикломатическая сложность**: снижение на 40%
- **Связанность модулей**: слабая связанность
- **Сцепление**: высокое сцепление внутри модулей
- **Покрытие тестами**: >80%
- **Время разработки новых функций**: сокращение на 50%

## ⚠️ Риски и митигация

### 🔴 Риски:
1. **Поломка существующей функциональности**
   - Митигация: поэтапное тестирование после каждого этапа
2. **Изменение API интерфейсов**
   - Митигация: сохранение обратной совместимости
3. **Ошибки в путях импортов**
   - Митигация: автоматизированные тесты импортов

### 🟡 Предупреждения:
- На каждом этапе ОБЯЗАТЕЛЬНО запускать тесты
- Сохранять backup до начала рефакторинга
- Проверять работу основной функциональности после каждого этапа

## 🎯 Критерии успеха

- [ ] Все тесты проходят
- [ ] Основная функциональность работает идентично
- [ ] Все файлы <200 строк
- [ ] Покрытие тестами >80%
- [ ] Документация обновлена
- [ ] Время выполнения не увеличилось >10%

---

**Общее время рефакторинга: 12-20 часов**
**Рекомендуемый график: 2-3 дня по 4-6 часов** 
# План интеграции с HubSpot

## Обзор
Данный план описывает интеграцию системы генерации описаний компаний с HubSpot CRM. Система будет проверять наличие актуальных описаний в HubSpot перед генерацией новых, а также сохранять новые описания в CRM.

## Основная логика

- [ ] **Создать изолированный модуль для работы с HubSpot API**
  - [ ] Создать файл `hubspot_client.py` с классом для работы с API
  - [ ] Реализовать методы аутентификации
  - [ ] Реализовать методы поиска компаний по домену
  - [ ] Реализовать методы получения свойств компании
  - [ ] Реализовать методы обновления свойств компании

- [ ] **Разработать класс-адаптер для интеграции HubSpot с основным пайплайном**
  - [ ] Создать файл `hubspot_adapter.py`
  - [ ] Реализовать метод проверки актуальности описания (не старше 6 месяцев)
  - [ ] Реализовать метод извлечения домена из URL
  - [ ] Реализовать логику принятия решения о необходимости генерации

- [ ] **Модифицировать основной пайплайн для поддержки интеграции**
  - [ ] Добавить конфигурационный параметр для включения/отключения интеграции с HubSpot
  - [ ] Встроить проверку HubSpot перед отправкой запроса на генерацию
  - [ ] Добавить логику сохранения результатов в HubSpot после генерации

- [ ] **Обработка данных**
  - [ ] Реализовать проверку наличия URL во входных данных
  - [ ] Реализовать нормализацию доменов (удаление www, протокола, параметров)
  - [ ] Добавить обработку ошибок при работе с HubSpot API

- [ ] **Тестирование**
  - [ ] Создать тесты для проверки работы с HubSpot API
  - [ ] Создать тесты для проверки логики принятия решений
  - [ ] Протестировать работу системы с включенной и отключенной интеграцией

## Детальный процесс работы

1. **Входная точка интеграции**
   - [ ] Проверка наличия URL компании во входных данных
   - [ ] Извлечение домена из URL
   - [ ] Поиск компании в HubSpot по домену

2. **Проверка существующих данных**
   - [ ] Получение свойства `ai_description_updated` (таймстамп)
   - [ ] Проверка, что таймстамп не старше 6 месяцев
   - [ ] Получение свойства `ai_description` при актуальности

3. **Логика обработки**
   - [ ] Если компания не найдена в HubSpot → обработка по стандартному пайплайну
   - [ ] Если `ai_description_updated` пустое или старше 6 месяцев → обработка по стандартному пайплайну
   - [ ] Если `ai_description_updated` актуально → использование существующего описания из HubSpot

4. **Сохранение результатов**
   - [ ] Сохранение сгенерированного описания в HubSpot (свойство `ai_description`)
   - [ ] Обновление таймстампа в HubSpot (свойство `ai_description_updated`)
   - [ ] Сохранение финального результата (из HubSpot или нового) в выходной CSV файл

## Конфигурация и управление

- [ ] **Настройки интеграции**
  - [ ] Создать файл конфигурации для HubSpot (API ключи, URL)
  - [ ] Добавить параметр `use_hubspot_integration` (true/false) в основной конфиг
  - [ ] Добавить параметр для указания периода актуальности (по умолчанию 6 месяцев)

- [ ] **Логирование и мониторинг**
  - [ ] Добавить логирование всех операций с HubSpot
  - [ ] Создать метрики использования HubSpot (сколько запросов, сколько найдено, сколько обновлено)
  - [ ] Реализовать обработку ошибок и повторные попытки при сбоях API

## Реализация изоляции

Для обеспечения возможности легкого отключения интеграции с HubSpot:

- [ ] Использовать паттерн Стратегия для выбора источника данных
- [ ] Реализовать класс-заглушку, который будет использоваться при отключенной интеграции
- [ ] Проверять флаг `use_hubspot_integration` в начале обработки каждой компании
- [ ] Обеспечить корректную работу системы даже при недоступности HubSpot API 
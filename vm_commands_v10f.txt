# Company Canvas v10f - Circuit Breaker & State Management
# –î–∞—Ç–∞: 2024-12-09
# –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
# - üõ°Ô∏è Circuit Breaker Pattern –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç rate limiting
# - üíæ State Management —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
# - üîÑ Recovery System –¥–ª—è –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ—Ä–≤–∞–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–π
# - üìä Enhanced monitoring –∏ logging

# ========================
# –õ–û–ö–ê–õ–¨–ù–´–ï –ö–û–ú–ê–ù–î–´
# ========================

# 1. –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞
docker build -t company-canvas-app .

# 2. –¢–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
docker tag company-canvas-app sergeykostichev/company-canvas-app:v10f

# 3. Push –≤ DockerHub
docker push sergeykostichev/company-canvas-app:v10f

# ========================
# –ö–û–ú–ê–ù–î–´ –î–õ–Ø VM
# ========================

# 1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ VM
ssh –≤–∞—à_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å@IP_–∞–¥—Ä–µ—Å_VM

# 2. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker stop company-canvas-prod
docker rm company-canvas-prod

# 3. –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –æ–±—Ä–∞–∑–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
docker rmi sergeykostichev/company-canvas-app:v10e

# 4. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑–∞
docker pull sergeykostichev/company-canvas-app:v10f

# 5. –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker run -d --restart unless-stopped -p 80:8000 \
  -e OPENAI_API_KEY="–≤–∞—à_—Ä–µ–∞–ª—å–Ω—ã–π_openai_–∫–ª—é—á" \
  -e SERPER_API_KEY="–≤–∞—à_—Ä–µ–∞–ª—å–Ω—ã–π_serper_–∫–ª—é—á" \
  -e SCRAPINGBEE_API_KEY="–≤–∞—à_—Ä–µ–∞–ª—å–Ω—ã–π_scrapingbee_–∫–ª—é—á" \
  -e HUBSPOT_API_KEY="–≤–∞—à_—Ä–µ–∞–ª—å–Ω—ã–π_hubspot_–∫–ª—é—á" \
  -e HUBSPOT_BASE_URL="https://app.hubspot.com/contacts/–≤–∞—à_portal_id/record/0-2/" \
  -e DEBUG="false" \
  -e DISABLE_CIRCUIT_BREAKER="false" \
  --name company-canvas-prod \
  -v /srv/company-canvas/output:/app/output \
  -v /srv/company-canvas/sessions_metadata.json:/app/sessions_metadata.json \
  sergeykostichev/company-canvas-app:v10f

# 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã
docker ps
docker logs company-canvas-prod
docker logs -f company-canvas-prod

# ========================
# –ù–û–í–´–ï –í–û–ó–ú–û–ñ–ù–û–°–¢–ò v10f
# ========================

# CLI –∫–æ–º–∞–Ω–¥—ã –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏—è–º–∏:

# –ü–æ–∫–∞–∑–∞—Ç—å –≤–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º—ã–µ —Å–µ—Å—Å–∏–∏
docker exec company-canvas-prod python services/criteria_processor/main.py --list-resumable

# –í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ—Ä–≤–∞–Ω–Ω—É—é —Å–µ—Å—Å–∏—é
docker exec company-canvas-prod python services/criteria_processor/main.py --resume-session crit_20241209_123456

# –ó–∞–ø—É—Å–∫ —Å –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã–º Circuit Breaker (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
docker exec company-canvas-prod python services/criteria_processor/main.py --parallel --disable-circuit-breaker --session-id test_without_cb

# ========================
# MONITORING
# ========================

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Circuit Breaker —Å–æ–±—ã—Ç–∏–π –≤ –ª–æ–≥–∞—Ö
docker logs company-canvas-prod | grep "Circuit Breaker"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ State Manager —Å–æ–±—ã—Ç–∏–π
docker logs company-canvas-prod | grep "State Manager"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ saved progress
docker exec company-canvas-prod find /app/output -name "*_progress.json" -exec ls -la {} \;

# ========================
# TROUBLESHOOTING v10f
# ========================

# –ï—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å "–∑–∞–≤–∏—Å" –Ω–∞ rate limiting:
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ Circuit Breaker –≤ –ª–æ–≥–∞—Ö
# 2. –ü–æ–¥–æ–∂–¥–∞—Ç—å 2-3 –º–∏–Ω—É—Ç—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
# 3. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å —Å–µ—Å—Å–∏—é

# –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å:
docker run ... -e MAX_CONCURRENT_COMPANIES="3" ...

# –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å Circuit Breaker:
docker run ... -e DISABLE_CIRCUIT_BREAKER="true" ... 
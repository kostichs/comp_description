# Документация по пайплайну поиска информации о компаниях

## Обзор системы

Пайплайн представляет собой модульную систему для поиска информации о компаниях и генерации структурированных описаний. Система разработана с учетом расширяемости и легкой интеграции новых источников данных и методов обработки информации.

## Архитектура

Пайплайн состоит из нескольких ключевых компонентов:

1. **Финдеры (Finders)** - модули, ответственные за поиск конкретных типов информации о компаниях
2. **Генератор описаний (Description Generator)** - модуль для создания структурированных описаний на основе собранных данных
3. **Процессор результатов (Result Processor)** - обрабатывает и сохраняет результаты поиска
4. **Оркестратор (Orchestrator)** - координирует работу всех компонентов пайплайна

### Компоненты пайплайна

#### Финдеры (Finders)

Финдеры - это модули, наследуемые от базового класса `Finder` (finders/base.py), которые реализуют асинхронный метод `find()`. Каждый финдер специализируется на поиске определенного типа информации:

- **HomepageFinder**: поиск официального сайта компании
- **LinkedInFinder**: поиск LinkedIn-страницы компании
- **LLMDeepSearchFinder**: использует GPT-4o-mini-search-preview для глубокого поиска информации в интернете

Все финдеры следуют единому интерфейсу и возвращают результаты в стандартизированном формате:

```python
{
    "source": "название_финдера",
    "result": "найденные_данные",
    "error": "информация_об_ошибке" # опционально
}
```

#### Генератор описаний (Description Generator)

Генератор описаний принимает данные, собранные финдерами, и создает структурированные трехабзацные описания компаний на английском языке. Основные компоненты:

- **generator.py**: содержит логику обработки данных и взаимодействия с API OpenAI
- **config.py**: содержит конфигурацию модели и промпты

Генератор приоритизирует информацию от LLMDeepSearchFinder, который предоставляет наиболее полные и актуальные данные о компании.

#### Процессор результатов (Result Processor)

Процессор результатов отвечает за:
- Агрегацию данных от всех финдеров
- Форматирование результатов
- Сохранение в JSON и Excel-форматах
- Логирование процесса поиска

#### Оркестратор (Orchestrator)

Оркестратор координирует работу всех компонентов пайплайна:
- Инициализирует финдеры и генератор описаний
- Запускает поиск информации асинхронно для каждой компании
- Собирает результаты от всех финдеров
- Передает данные генератору описаний
- Отправляет финальные результаты процессору для сохранения

## Принцип работы пайплайна

1. **Загрузка данных**:
   - Пайплайн читает список компаний из входного файла
   - Создает директории для сохранения результатов и логов

2. **Инициализация компонентов**:
   - Создаются экземпляры всех финдеров и генератора описаний
   - Загружаются API-ключи и конфигурации

3. **Поиск информации**:
   - Для каждой компании асинхронно запускаются все активные финдеры
   - Результаты от каждого финдера агрегируются

4. **Генерация описаний**:
   - Полученные данные передаются генератору описаний
   - Генератор создает структурированное описание компании на английском языке
   - Описание добавляется к результатам поиска

5. **Сохранение результатов**:
   - Результаты сохраняются в JSON и Excel-форматах
   - Генерируются подробные логи процесса

## Технический стек

- **Python 3.10+**: основной язык разработки
- **Asyncio**: для асинхронного выполнения запросов
- **OpenAI API**: для выполнения LLM-запросов (GPT-3.5-turbo, GPT-4o-mini-search-preview)
- **aiohttp**: для асинхронных HTTP-запросов
- **BeautifulSoup4**: для парсинга HTML-контента
- **Pandas**: для обработки и экспорта данных

## Как добавить новый финдер

Чтобы интегрировать новый источник данных, нужно создать новый финдер, следуя этим шагам:

1. **Создайте новый класс**, наследующийся от базового класса `Finder`:

```python
from finders.base import Finder

class NewSourceFinder(Finder):
    def __init__(self, api_key: str = None, verbose: bool = False):
        self.api_key = api_key
        self.verbose = verbose
        
    async def find(self, company_name: str, **context) -> dict:
        # Реализация поиска
        try:
            # Логика поиска информации
            result = "найденная информация"
            return {
                "source": "new_source_finder",
                "result": result
            }
        except Exception as e:
            return {
                "source": "new_source_finder",
                "result": None,
                "error": str(e)
            }
```

2. **Добавьте финдер в оркестратор** (orchestrator.py), импортировав его и добавив в список активных финдеров:

```python
from finders.new_source_finder import NewSourceFinder

# В методе инициализации оркестратора
self.finders = [
    # Существующие финдеры
    HomepageFinder(...),
    LinkedInFinder(...),
    LLMDeepSearchFinder(...),
    # Новый финдер
    NewSourceFinder(api_key=config.get("new_source_api_key"))
]
```

3. **Обновите обработку результатов** в генераторе описаний, если это необходимо.

## Настройка генератора описаний

Генератор описаний настраивается через файл `description_generator/config.py`:

- **DEFAULT_MODEL_CONFIG**: настройки модели OpenAI (модель, температура и т.д.)
- **SYSTEM_PROMPT**: системный промпт для LLM
- **USER_PROMPT_TEMPLATE**: шаблон пользовательского промпта

Чтобы изменить формат или язык генерируемых описаний, обновите соответствующие промпты в config.py.

## Запуск пайплайна

Пайплайн запускается через main.py, который вызывает функцию `run_pipeline()` из src/pipeline.py. Конфигурация загружается из .env файла и YAML-конфигураций.

```bash
python main.py
```

## Расширение функциональности

### Добавление нового способа генерации описаний

Чтобы добавить новый способ генерации описаний:

1. Создайте новый модуль в директории description_generator или расширьте существующий
2. Обновите config.py, добавив новые настройки и промпты
3. Модифицируйте метод _generate_summary_from_text() в generator.py или создайте новый метод

### Интеграция с другими сервисами

Для интеграции с новыми API-сервисами:

1. Добавьте конфигурацию нового сервиса в llm_config.yaml
2. Создайте новый клиент для API в src/external_apis/
3. Разработайте финдер, использующий этот API

## Лучшие практики

1. **Соблюдайте асинхронность**: все финдеры должны быть асинхронными для оптимальной производительности
2. **Обрабатывайте ошибки**: правильно обрабатывайте и логируйте ошибки, возвращая структурированные ответы
3. **Следуйте стандартам кода**: придерживайтесь PEP 8 и документируйте код
4. **Тестируйте новые компоненты**: создавайте тестовые скрипты для проверки работоспособности
5. **Отделяйте конфигурацию от кода**: выносите все настройки в отдельные конфигурационные файлы

## Заключение

Пайплайн поиска информации о компаниях представляет собой гибкую, расширяемую систему, способную интегрировать различные источники данных и методы обработки информации. Модульная архитектура позволяет легко добавлять новые компоненты и улучшать существующие функции без необходимости переработки всей системы. 